{% if is_rtl %}
  {{ attach_library('hq/block.sidebar-navigation-topic-hierarchical-navigation-rtl') }}
{% else %}
  {{ attach_library('hq/block.sidebar-navigation-topic-hierarchical-navigation') }}
{% endif %}

{% set current_path = path('<current>') %}
{% import _self as macros %}

<nav class="topic-navigation">
  <div class="topic-navigation-heading">
    <h6 class="section-label">In this section</h6>
    <button class="mobile-menu-toggle" aria-expanded="false" aria-controls="topic-menu">
      <span class="sr-only">Toggle mobile menu</span>
    </button>
  </div>

  <div id="topic-menu" class="topic-menu-content">
    <ul class="topic-tree">
      {% for item in content.items %}
        {% if loop.index == 10 %}
          <div class="topic-hidden-wrapper hidden">
        {% endif %}

        {% set is_active = item.url == current_path %}
        {% set has_active_child = macros.is_active_in_subtree(item, current_path) == '1' %}
        {% set is_open = is_active or has_active_child %}

        <li class="topic-item level-0 {{ is_active ? ' is-active' : '' }} {{ (item.children is defined and item.children|length) ? ' has-children' : '' }} {{ is_open ? ' is-open' : '' }}">
          <div class="topic-link-wrapper">
            {% if item.children is defined and item.children is not empty %}
              <button class="toggle" aria-expanded="{{ is_open ? 'true' : 'false' }}" aria-label="Toggle submenu" type="button">
                {{ is_open ? '−' : '+' }}
              </button>
            {% endif %}
            <a href="{{ item.url }}" class="{{ is_active ? 'is-active' : '' }}">{{ item.title }}</a>
          </div>

          {% if item.children is defined and item.children is not empty %}
            <ul class="topic-subtree">
              {% for child in item.children %}
                {% set child_is_active = child.url == current_path %}
                {% set child_has_active = macros.is_active_in_subtree(child, current_path) == '1' %}
                {% set child_is_open = child_is_active or child_has_active %}

                <li class="topic-item level-1 {{ child_is_active ? ' is-active' : '' }} {{ (child.children is defined and child.children|length) ? ' has-children' : '' }} {{ child_is_open ? ' is-open' : '' }}">
                  {{ macros.render_topic_item(child, 2, current_path) }}
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </li>

        {% if loop.last and content.items|length > 9 %}
          </div>
        {% endif %}
      {% endfor %}
    </ul>

    {% if content.items|length > 9 %}
      <button class="see-more-button" type="button">See more</button>
      <button class="see-less-button hidden" type="button">See less</button>
    {% endif %}
  </div>
</nav>

{% macro render_topic_item(item, level, current_path) %}
  {% import _self as macros %}

  {% set is_active = item.url == current_path %}
  {% set has_active_child = macros.is_active_in_subtree(item, current_path) == '1' %}
  {% set is_open = is_active or has_active_child %}

  <div class="topic-link-wrapper">
    {% if item.children is defined and item.children is not empty %}
      <button class="toggle" aria-expanded="{{ is_open ? 'true' : 'false' }}" aria-label="Toggle submenu" type="button">
        {{ is_open ? '−' : '+' }}
      </button>
    {% endif %}
    <a href="{{ item.url }}" class="{{ is_active ? 'is-active' : '' }}">{{ item.title }}</a>
  </div>

  {% if item.children is defined and item.children is not empty %}
    <ul class="topic-subtree">
      {% for child in item.children %}
        {% set child_is_active = child.url == current_path %}
        {% set child_has_active = macros.is_active_in_subtree(child, current_path) == '1' %}
        {% set child_is_open = child_is_active or child_has_active %}

        <li class="topic-item level-{{ level }} {{ child_is_active ? ' is-active' : '' }} {{ (child.children is defined and child.children|length) ? ' has-children' : '' }} {{ child_is_open ? ' is-open' : '' }}">
          {{ macros.render_topic_item(child, level + 1, current_path) }}
        </li>
      {% endfor %}
    </ul>
  {% endif %}
{% endmacro %}

{% macro is_active_in_subtree(item, current_path) %}
  {% import _self as macros %}
  {% set found = false %}

  {% if item.children is defined and item.children is not empty %}
    {% for child in item.children %}
      {% if child.url == current_path %}
        {% set found = true %}
      {% elseif macros.is_active_in_subtree(child, current_path) == '1' %}
        {% set found = true %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {{ found ? '1' : '' }}
{% endmacro %}
